-- Purpose: Handles N-flag button when an @-device is active. Creates new tab in @-device window.
-- Placeholders: {{safe_target_title}}, {{final_script_payload_for_do_script}}

tell application "Terminal"
	activate
	set found_window to false
	set target_w_for_new_tab to missing value
	
	try
		repeat with w in windows
			if custom title of w is "{{safe_target_title}}" then
				set target_w_for_new_tab to w
				set found_window to true
				exit repeat
			end if
		end repeat
	on error find_err_case2
		log "AS: Error finding existing window for N-button target tab '{{safe_target_title}}': " & find_err_case2
	end try
	
	if found_window and target_w_for_new_tab is not missing value then
		tell target_w_for_new_tab to activate
		if "{{final_script_payload_for_do_script}}" is not "" then
			try
				do script "{{final_script_payload_for_do_script}}" in target_w_for_new_tab
			on error errMsg
				log "AS: Error doing script in N-button target tab '{{safe_target_title}}': " & errMsg
				do script "{{final_script_payload_for_do_script}}" 
			end try
		end if
	else
		log "AS: Target window '{{safe_target_title}}' for N-flag tab not found. Running in new default window."
		if "{{final_script_payload_for_do_script}}" is not "" then
			do script "{{final_script_payload_for_do_script}}"
		end if
	end if
end tell